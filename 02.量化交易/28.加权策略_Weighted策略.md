# 加权策略（Weighted Strategy）：体系化介绍、原理与量化应用

## 目录
1. [加权策略概述](#一-加权策略概述)
2. [统一表述：信号加权与组合权重](#二-统一表述信号加权与组合权重)
3. [常见加权方案（“星系/体系”）](#三-常见加权方案星系体系)
4. [约束、稳健性与交易成本](#四-约束稳健性与交易成本)
5. [再平衡与动态加权](#五-再平衡与动态加权)
6. [评估指标与诊断](#六-评估指标与诊断)
7. [量化交易中的典型应用](#七-量化交易中的典型应用)
8. [常见坑与实践建议](#八-常见坑与实践建议)
9. [总结](#九-总结)

---

## 一、加权策略概述

### 1.1 什么是“加权策略”

在量化语境里，**加权策略（Weighted Strategy）**通常指：

- **信号层加权**：把多个 alpha/模型/因子信号按权重合成一个总信号；
- **资产层加权**：把资金在多资产/多标的/多子策略之间按权重分配；
- **风险层加权**：按风险贡献、波动、相关性等把风险“均衡”或“定向”分配。

它的核心不是“选不选”，而是“选了以后怎么分配权重”。

### 1.2 为什么“加权”很重要

- **信息密度**：同样一组标的，权重决定了组合暴露（行业/风格/因子/久期/杠杆）。
- **风险形态**：权重决定波动、回撤、尾部风险、集中度。
- **可控性**：引入约束后，加权可以把“策略观点”转化为可执行的仓位。
- **工程现实**：交易成本、流动性、冲击成本通常主要由“换手与权重”决定。

### 1.3 两类常见问题

- **给定一组打分/预测**：如何把分数变成权重？（score → weight）
- **给定一个目标（收益、夏普、风险贡献）**：如何反推最合适的权重？（objective → weight）

---

## 二、统一表述：信号加权与组合权重

设有 $m$ 个信号（或子策略）$s_1,\dots,s_m$，对单一标的给出预测/评分；也可将 $s_i$ 视为对全市场的向量信号。

### 2.1 信号合成（Ensemble / Alpha blend）

一个常见合成方式是线性加权：

$$
S = \sum_{i=1}^{m} a_i s_i
$$

其中 $a_i$ 为信号权重（可固定，也可随时间变化）。

**直觉**：$a_i$ 越大，表示越信任该信号（信息含量更高、稳定性更强或成本更低）。
### 2.2 组合权重（Portfolio weights）的标准定义

设有 $N$ 个标的，组合权重向量为 $\mathbf{w}=(w_1,\dots,w_N)^T$。

- **资金权重（fully-invested long-only）**：
  $$\sum_{i=1}^{N} w_i = 1, \quad w_i \ge 0$$
  解释：全部资金投入，且只做多。

- **允许杠杆（gross exposure）**：
  $$\sum_{i=1}^{N} |w_i| \le L$$
  解释：$L$ 控制总敞口（含多空），越大杠杆越高、换手与尾部风险越敏感。

- **市场中性（dollar-neutral / beta-neutral 的一种简化）**：
  $$\sum_{i=1}^{N} w_i = 0$$
  解释：多头与空头名义金额相抵（并不等价于 beta=0，但常作为第一道约束）。

- **行业/因子约束（示例）**：
  $$\mathbf{B}^T \mathbf{w} = \mathbf{b}_0, \quad \mathbf{w} \in [\mathbf{l},\mathbf{u}]$$
  其中 $\mathbf{B}$ 可为行业哑变量或风险因子暴露矩阵。

### 2.3 从“信号”到“权重”：三类映射

很多策略失败不是信号不行，而是 **score→weight 映射不稳健**。常见映射分三类：

**A. 排序/分桶式（Rank / Quantile）**
- 先按 $S_i$ 排序，选 Top-K 做多、Bottom-K 做空。
- 权重可以等权，或按排名线性/非线性分配。

**B. 连续函数映射（Score transform）**
给定每个标的得分 $S_i$，用函数 $f$ 变换并归一化：

- long-only：
  $$w_i = \frac{f(S_i)}{\sum_j f(S_j)},\quad f(S)\ge 0$$
- 多空（先去中心）：
  $$\tilde S_i = S_i - \bar S,\quad w_i = \frac{\tilde S_i}{\sum_j |\tilde S_j|}\,L$$

常用 $f$：截断线性、Softmax、tanh、分段函数（控制极端权重）。

**C. 目标优化式（Objective-based）**
把权重当决策变量：

$$
\max_{\mathbf{w}}\; \underbrace{\boldsymbol{\mu}^T\mathbf{w}}_{\text{预期收益}} - \lambda\underbrace{\mathbf{w}^T\boldsymbol{\Sigma}\mathbf{w}}_{\text{风险}} - \gamma\underbrace{\|\mathbf{w}-\mathbf{w}_{prev}\|_1}_{\text{换手/成本代理}}
$$

其中 $\boldsymbol{\mu}$ 来自预测/信号，$\boldsymbol{\Sigma}$ 为协方差估计。### 2.4 归一化与“可交易化”细节

无论是信号合成还是权重生成，实盘前通常要做三件事：

1) **截断（winsorize / clip）**：控制极端权重与极端信号
- 例如 $w_i \in [l_i,u_i]$ 或对 $S_i$ 做分位数截断。

2) **中性化（neutralize）**：去掉你不想暴露的维度
- 行业中性、风格中性、beta 中性等。

3) **平滑（smoothing）**：降低换手
- 例如指数平滑：
  $$\mathbf{w}_t = (1-\rho)\mathbf{w}^*_t + \rho\mathbf{w}_{t-1},\quad \rho\in[0,1)$$

---

## 三、常见加权方案（“星系/体系”）

这里把常见加权方法按“你在平衡什么”划分为几大体系（可把它理解为加权策略的‘星系’）：

1. **规模/资金体系**：等权、市值权重、流动性权重
2. **风险体系**：逆波动、风险平价、最小方差、最大分散
3. **收益预测体系**：最大夏普/均值-方差、信号比例、Kelly 近似
4. **稳健/防过拟合体系**：收缩估计、Black-Litterman、约束优化、正则化
5. **工程/交易体系**：成本敏感、换手惩罚、分批执行、目标跟踪

### 3.1 等权（Equal Weight）

- long-only：$w_i=1/N$
- 多空（Top-K/Bottom-K 等权）：
  $$w_i=\begin{cases}+\frac{L}{2K},& i\in\text{Top-K}\\-\frac{L}{2K},& i\in\text{Bottom-K}\\0,&\text{else}\end{cases}$$

**优点**：简单、稳健、对估计误差不敏感。

**缺点**：容易隐含小盘/高波动暴露；如果标的波动差异大，风险集中。

### 3.2 市值加权（Cap Weight）与流动性加权

- 市值加权：$w_i \propto \text{MktCap}_i$
- 流动性加权：$w_i \propto \text{ADV}_i$（平均成交额）

**常见用途**：构造基准、控制冲击成本、做可交易的指数化暴露。

**关键提醒**：市值加权不是“最优”，它更像“市场组合/基准选择”。

### 3.3 逆波动加权（Inverse Volatility）

设波动估计为 $\sigma_i$，则：

$$w_i = \frac{\sigma_i^{-1}}{\sum_j \sigma_j^{-1}}$$

**直觉**：让高波动标的权重更小，组合风险更均衡。

**常见变体**：$w_i \propto \sigma_i^{-p}$，$p\in[0.5,2]$ 控制力度。
### 3.4 风险平价（Risk Parity）与等风险贡献（ERC）

风险体系的核心不是“资金等分”，而是“**风险等分**”。

设协方差矩阵为 $\boldsymbol{\Sigma}$，组合波动：

$$\sigma_p = \sqrt{\mathbf{w}^T\boldsymbol{\Sigma}\mathbf{w}}$$

定义第 $i$ 个标的的**边际风险贡献**（MRC）：

$$\text{MRC}_i = \frac{\partial \sigma_p}{\partial w_i} = \frac{(\boldsymbol{\Sigma}\mathbf{w})_i}{\sigma_p}$$

定义**风险贡献**（RC）：

$$\text{RC}_i = w_i\,\text{MRC}_i = \frac{w_i(\boldsymbol{\Sigma}\mathbf{w})_i}{\sigma_p}$$

**ERC（Equal Risk Contribution）**目标：

$$\text{RC}_1=\cdots=\text{RC}_N$$

它通常需要数值优化求解（并配合 $w_i\ge 0$、上限约束等）。

**适用性**：当你更关心“风险预算”而非“收益预测”时，风险平价往往比均值-方差更稳健。
### 3.5 最小方差（Minimum Variance / GMV）

**目标**：在约束下最小化组合方差：

$$
\min_{\mathbf{w}}\; \mathbf{w}^T\boldsymbol{\Sigma}\mathbf{w}\quad \text{s.t.}\; \sum_i w_i=1,\; \mathbf{w}\in[\mathbf{l},\mathbf{u}]
$$

在无上下限、仅有 $\sum w_i=1$ 的理想情形，有经典解析形式（GMV）：

$$
\mathbf{w}_{gmv} = \frac{\boldsymbol{\Sigma}^{-1}\mathbf{1}}{\mathbf{1}^T\boldsymbol{\Sigma}^{-1}\mathbf{1}}
$$

**优点**：对收益预测误差不敏感（不需要 $\boldsymbol{\mu}$）。

**缺点**：极其依赖协方差估计；在高维小样本下容易不稳，常需要收缩/正则化（见第 4 节）。
### 3.6 最大夏普/均值-方差（Mean-Variance / Tangency）

当你有明确的收益预测 $\boldsymbol{\mu}$ 时，经典均值-方差框架为：

$$
\max_{\mathbf{w}}\; \boldsymbol{\mu}^T\mathbf{w} - \lambda\mathbf{w}^T\boldsymbol{\Sigma}\mathbf{w}
$$

或最大化夏普（等价于某种缩放下的风险收益比）：

$$
\max_{\mathbf{w}}\; \frac{\boldsymbol{\mu}^T\mathbf{w}}{\sqrt{\mathbf{w}^T\boldsymbol{\Sigma}\mathbf{w}}}
$$

在无约束且允许缩放的理想情形，方向解为：

$$\mathbf{w}\propto \boldsymbol{\Sigma}^{-1}\boldsymbol{\mu}$$

**关键现实**：真实市场里必须加入约束与成本项，否则会得到极端权重、巨大换手。
